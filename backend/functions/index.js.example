/**
 * Cloud Functions Entry Point for Hope Physicians API
 * 
 * This file wraps the Express.js backend as a Cloud Function
 * Deploy with: firebase deploy --only functions
 */

const functions = require('firebase-functions');
const admin = require('firebase-admin');
const express = require('express');
const cors = require('cors');

// Initialize Firebase Admin SDK
// This gives access to Firestore, Auth, Storage, etc.
admin.initializeApp();

const app = express();

// CORS Configuration
// Update these origins with your actual Firebase Hosting URLs
const corsOptions = {
  origin: [
    'http://localhost:5173', // Local Vite dev server
    'https://your-project-id.web.app', // Firebase Hosting
    'https://your-project-id.firebaseapp.com', // Firebase Hosting alt
    'https://yourdomain.com', // Custom domain
    'https://www.yourdomain.com', // Custom domain with www
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
};

app.use(cors(corsOptions));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Import your existing routes
// Note: Adjust paths based on your actual file structure
const appointmentRoutes = require('../routes/appointmentRoutes');
const adminRoutes = require('../routes/adminRoutes');
const doctorRoutes = require('../routes/doctorRoutes');
const authRoutes = require('../routes/authRoutes');
const patientRoutes = require('../routes/patientRoutes');
const patientFormRoutes = require('../routes/patientFormRoutes');

// Mount API routes
app.use('/api/auth', authRoutes);
app.use('/api/appointments', appointmentRoutes);
app.use('/api/admin', adminRoutes);
app.use('/api/doctor', doctorRoutes);
app.use('/api/patients', patientRoutes);
app.use('/api/patient-forms', patientFormRoutes);

// Health check endpoint
app.get('/', (req, res) => {
  res.json({
    status: 'HOPE PHYSICIAN API is running...',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'production',
  });
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(err.status || 500).json({
    error: err.message || 'Internal Server Error',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack }),
  });
});

// Export as Cloud Function
// This makes your Express app available as a Cloud Function
exports.api = functions
  .runWith({
    timeoutSeconds: 300, // 5 minutes (max)
    memory: '512MB', // Adjust based on needs
  })
  .https.onRequest(app);

// Optional: Export individual functions for better isolation
// Example:
// exports.getAppointments = functions.https.onRequest(async (req, res) => {
//   // Individual function logic
// });

