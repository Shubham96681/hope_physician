name: Full Stack CI/CD

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Cache backend dependencies
      uses: actions/cache@v3
      id: cache-backend
      with:
        path: backend/node_modules
        key: backend-${{ hashFiles('backend/package-lock.json') }}
        
    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        elif [ -f yarn.lock ]; then
          yarn install --frozen-lockfile
        else
          npm install
        fi
      
    - name: Generate Prisma Client
      working-directory: ./backend
      run: npm run prisma:generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL || 'file:./dev.db' }}
        JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key' }}
        
    - name: Upload backend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: |
          backend/
        retention-days: 7

  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
      
    - name: Cache frontend dependencies
      uses: actions/cache@v3
      id: cache-frontend
      with:
        path: frontend/node_modules
        key: frontend-${{ hashFiles('frontend/package-lock.json') }}
      
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        elif [ -f yarn.lock ]; then
          yarn install --frozen-lockfile
        else
          npm install
        fi
      
    - name: Run linter
      working-directory: ./frontend
      run: npm run lint
      continue-on-error: true
      
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:5000/api' }}
        NODE_ENV: production
      
    - name: Upload frontend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist
        retention-days: 7

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts || true
        
    - name: Deploy to EC2
      env:
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        RAZORPAY_KEY_ID: ${{ secrets.RAZORPAY_KEY_ID }}
        RAZORPAY_KEY_SECRET: ${{ secrets.RAZORPAY_KEY_SECRET }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        PORT: ${{ secrets.PORT || '5000' }}
        NODE_ENV: ${{ secrets.NODE_ENV || 'production' }}
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:5000/api' }}
      run: |
        # Create deployment directory on EC2
        ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "mkdir -p ~/hope-physicians/backend"
        ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "mkdir -p ~/hope-physicians/frontend/dist"
        
        # Copy entire backend directory (excluding node_modules)
        rsync -avz --exclude node_modules --exclude '.git*' artifacts/backend-build/ $EC2_USER@$EC2_HOST:~/hope-physicians/backend/
        
        # Copy frontend build
        rsync -avz artifacts/frontend-build/ $EC2_USER@$EC2_HOST:~/hope-physicians/frontend/dist/
        
        # Copy deployment scripts
        scp deploy.sh $EC2_USER@$EC2_HOST:~/hope-physicians/ || true
        scp ecosystem.config.js $EC2_USER@$EC2_HOST:~/hope-physicians/ || true
        scp check-deployment.sh $EC2_USER@$EC2_HOST:~/hope-physicians/ || true
        
        # Run deployment script on EC2
        ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "cd ~/hope-physicians && chmod +x deploy.sh && export JWT_SECRET='$JWT_SECRET' && export EMAIL_USER='$EMAIL_USER' && export EMAIL_PASS='$EMAIL_PASS' && export RAZORPAY_KEY_ID='$RAZORPAY_KEY_ID' && export RAZORPAY_KEY_SECRET='$RAZORPAY_KEY_SECRET' && export DATABASE_URL='$DATABASE_URL' && export PORT='${PORT:-5000}' && export NODE_ENV='${NODE_ENV:-production}' && export VITE_API_URL='$VITE_API_URL' && bash deploy.sh"

  status:
    name: CI/CD Status
    runs-on: ubuntu-latest
    needs: [backend, frontend, deploy]
    if: always()
    
    steps:
    - name: Display Status
      run: |
        echo "Backend CI: ${{ needs.backend.result }}"
        echo "Frontend CI: ${{ needs.frontend.result }}"
        echo "Deployment: ${{ needs.deploy.result }}"
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "üöÄ Deployment completed successfully!"
        else
          echo "‚ùå Deployment failed. Check logs for details."
          exit 1
        fi
