name: Full Stack CI/CD

on:
  push:
    branches: [master, main]
    paths:
      # Only run when these paths change
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/full-stack-ci.yml"
      - "deploy.sh"
      - "ecosystem.config.js"
      - "package.json"
      - "package-lock.json"
  pull_request:
    branches: [master, main]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/full-stack-ci.yml"
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Remove root package-lock.json if exists
        run: |
          if [ -f package-lock.json ]; then
            echo "Removing root package-lock.json"
            rm -f package-lock.json
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npm run prisma:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'file:./dev.db' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key' }}

      - name: Upload backend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            backend/
          retention-days: 7

  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Remove root package-lock.json if exists
        run: |
          if [ -f package-lock.json ]; then
            echo "Removing root package-lock.json"
            rm -f package-lock.json
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps

      - name: Run linter
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          # No VITE_API_URL needed - using runtime config in index.html
          # API URL auto-detects based on hostname (production uses /api via Nginx)
          NODE_ENV: production

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts || true

          # Test SSH connection with longer timeout
          echo "üîç Testing SSH connection to $EC2_HOST..."
          for i in {1..3}; do
            echo "Attempt $i/3..."
            if ssh -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=3 \
              $EC2_USER@$EC2_HOST "echo 'SSH connection successful'" 2>&1; then
              echo "‚úÖ SSH connection successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚è≥ Retrying in 5 seconds..."
                sleep 5
              else
                echo "‚ùå SSH connection failed after 3 attempts"
                echo "‚ö†Ô∏è  Troubleshooting tips:"
                echo "   1. Verify EC2 instance is running"
                echo "   2. Check security group allows SSH (port 22) from GitHub Actions IPs"
                echo "   3. Verify EC2_HOST secret is correct: $EC2_HOST"
                echo "   4. Check EC2 instance public IP hasn't changed"
                exit 1
              fi
            fi
          done

      - name: Deploy to EC2
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          RAZORPAY_KEY_ID: ${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET: ${{ secrets.RAZORPAY_KEY_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PORT: ${{ secrets.PORT || '5000' }}
          NODE_ENV: ${{ secrets.NODE_ENV || 'production' }}
          # VITE_API_URL not needed - using runtime config in index.html
        run: |
          # Create deployment directory on EC2
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            $EC2_USER@$EC2_HOST "mkdir -p ~/hope-physicians/backend"
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            $EC2_USER@$EC2_HOST "mkdir -p ~/hope-physicians/frontend/dist"

          # Copy entire backend directory (excluding node_modules)
          rsync -avz \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
            --exclude node_modules \
            --exclude '.git*' \
            artifacts/backend-build/ $EC2_USER@$EC2_HOST:~/hope-physicians/backend/ || {
            echo "Rsync failed, trying scp..."
            scp -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -r artifacts/backend-build/* $EC2_USER@$EC2_HOST:~/hope-physicians/backend/
          }

          # Copy frontend build to Nginx web root
          echo "üì¶ Copying frontend build to server..."
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            $EC2_USER@$EC2_HOST "mkdir -p ~/hope-physicians/frontend/dist"
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
            artifacts/frontend-build/ $EC2_USER@$EC2_HOST:~/hope-physicians/frontend/dist/ || {
            echo "Rsync failed, trying scp..."
            ssh -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              $EC2_USER@$EC2_HOST "rm -rf ~/hope-physicians/frontend/dist/*"
            scp -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -r artifacts/frontend-build/* $EC2_USER@$EC2_HOST:~/hope-physicians/frontend/dist/
          }
          echo "‚úÖ Frontend build copied to ~/hope-physicians/frontend/dist"

          # Copy deployment scripts
          scp -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            deploy.sh $EC2_USER@$EC2_HOST:~/hope-physicians/ || true
          scp -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            ecosystem.config.js $EC2_USER@$EC2_HOST:~/hope-physicians/ || true
          scp -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            check-deployment.sh $EC2_USER@$EC2_HOST:~/hope-physicians/ || true

          # Run deployment script on EC2
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            $EC2_USER@$EC2_HOST "cd ~/hope-physicians && chmod +x deploy.sh && export JWT_SECRET='$JWT_SECRET' && export EMAIL_USER='$EMAIL_USER' && export EMAIL_PASS='$EMAIL_PASS' && export RAZORPAY_KEY_ID='$RAZORPAY_KEY_ID' && export RAZORPAY_KEY_SECRET='$RAZORPAY_KEY_SECRET' && export DATABASE_URL='$DATABASE_URL' && export PORT='${PORT:-5000}' && export NODE_ENV='${NODE_ENV:-production}' && bash deploy.sh"

          # Verify frontend deployment
          echo "üîç Verifying frontend deployment..."
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            $EC2_USER@$EC2_HOST "ls -la ~/hope-physicians/frontend/dist/ | head -10"

          # Restart Nginx to serve new build
          echo "üîÑ Restarting Nginx..."
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            $EC2_USER@$EC2_HOST "sudo nginx -t && sudo systemctl restart nginx || sudo service nginx restart"

  status:
    name: CI/CD Status
    runs-on: ubuntu-latest
    needs: [backend, frontend, deploy]
    if: always()

    steps:
      - name: Display Status
        run: |
          echo "Backend CI: ${{ needs.backend.result }}"
          echo "Frontend CI: ${{ needs.frontend.result }}"
          echo "Deployment: ${{ needs.deploy.result }}"
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "üöÄ Deployment completed successfully!"
          else
            echo "‚ùå Deployment failed. Check logs for details."
            exit 1
          fi
