name: Deploy Multiple Apps to EC2

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name to deploy (leave empty for all apps)'
        required: false
        type: string

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  test-and-deploy:
    name: Test, Build & Deploy All Apps
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo "üîç Verifying SSH key format..."
        head -1 ~/.ssh/id_rsa | grep -q "BEGIN" && echo "‚úÖ SSH key format looks correct" || echo "‚ö†Ô∏è  SSH key might be missing BEGIN line"
        echo "üîç Testing SSH key file..."
        test -f ~/.ssh/id_rsa && echo "‚úÖ SSH key file exists" || echo "‚ùå SSH key file not found"
        echo "üîç Getting EC2 host fingerprint..."
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>&1 || echo "‚ö†Ô∏è  Could not get host fingerprint (might be normal)"
        echo "üîç Testing basic connectivity..."
        timeout 5 nc -zv $EC2_HOST 22 2>&1 || echo "‚ö†Ô∏è  Port 22 not reachable (might be normal if security group blocks)"
        
    # Deploy configuration and scripts to EC2
    - name: Deploy deployment scripts to EC2
      timeout-minutes: 5
      run: |
        echo "üì¶ Copying deployment scripts to EC2..."
        echo "üîç Testing SSH connection to $EC2_HOST..."
        
        # Retry SSH connection up to 3 times
        MAX_RETRIES=3
        RETRY_COUNT=0
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 $EC2_USER@$EC2_HOST "echo 'SSH connection successful'" 2>&1; then
            echo "‚úÖ SSH connection verified"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "‚è≥ Retrying in 5 seconds..."
              sleep 5
            else
              echo "‚ùå SSH connection failed after $MAX_RETRIES attempts"
              echo ""
              echo "üîç Diagnostic Information:"
              echo "   EC2_HOST: $EC2_HOST"
              echo "   EC2_USER: $EC2_USER"
              echo "   Testing port 22 connectivity..."
              timeout 5 bash -c "echo > /dev/tcp/$EC2_HOST/22" 2>/dev/null && echo "   ‚úÖ Port 22 is reachable" || echo "   ‚ùå Port 22 is NOT reachable"
              echo ""
              echo "‚ö†Ô∏è  Since SSH works locally but not from GitHub Actions:"
              echo "   1. Verify EC2_HOST secret matches the IP you use locally"
              echo "   2. Verify EC2_SSH_KEY secret is the SAME key that works locally"
              echo "   3. Check if security group change has propagated (wait 30 seconds)"
              echo "   4. Verify Network ACLs allow traffic (if using VPC)"
              echo "   5. Check if instance has iptables/firewall: ssh into instance and run 'sudo iptables -L'"
              echo "   6. If using Elastic IP, verify it's attached to the instance"
              exit 1
            fi
          fi
        done
        
        echo "üìÅ Creating deployment directory..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 $EC2_USER@$EC2_HOST "mkdir -p ~/deployment && echo 'Directory created'" || {
          echo "‚ùå Failed to create directory"
          exit 1
        }
        echo "‚úÖ Directory created"
        
        echo "üì§ Copying deploy-multi-app.sh ($(du -h deploy-multi-app.sh | cut -f1))..."
        timeout 60 scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 -o ServerAliveInterval=5 deploy-multi-app.sh $EC2_USER@$EC2_HOST:~/deployment/ || {
          echo "‚ùå Failed to copy deploy-multi-app.sh"
          exit 1
        }
        echo "‚úÖ deploy-multi-app.sh copied"
        
        echo "üì§ Copying apps.config.json ($(du -h apps.config.json | cut -f1))..."
        timeout 60 scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 -o ServerAliveInterval=5 apps.config.json $EC2_USER@$EC2_HOST:~/deployment/ || {
          echo "‚ùå Failed to copy apps.config.json"
          exit 1
        }
        echo "‚úÖ apps.config.json copied"
        
        echo "üì§ Copying ecosystem.config.js ($(du -h ecosystem.config.js | cut -f1))..."
        timeout 60 scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 -o ServerAliveInterval=5 ecosystem.config.js $EC2_USER@$EC2_HOST:~/deployment/ || {
          echo "‚ùå Failed to copy ecosystem.config.js"
          exit 1
        }
        echo "‚úÖ ecosystem.config.js copied"
        
        echo "‚úÖ All deployment scripts copied successfully"
        
    - name: Execute multi-app deployment script on EC2
      timeout-minutes: 30
      env:
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        RAZORPAY_KEY_ID: ${{ secrets.RAZORPAY_KEY_ID }}
        RAZORPAY_KEY_SECRET: ${{ secrets.RAZORPAY_KEY_SECRET }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NODE_ENV: ${{ secrets.NODE_ENV || 'production' }}
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
      run: |
        echo "üöÄ Starting multi-app deployment..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes $EC2_USER@$EC2_HOST "cd ~/deployment && chmod +x deploy-multi-app.sh && export JWT_SECRET='$JWT_SECRET' && export EMAIL_USER='$EMAIL_USER' && export EMAIL_PASS='$EMAIL_PASS' && export RAZORPAY_KEY_ID='$RAZORPAY_KEY_ID' && export RAZORPAY_KEY_SECRET='$RAZORPAY_KEY_SECRET' && export DATABASE_URL='$DATABASE_URL' && export NODE_ENV='${NODE_ENV:-production}' && export VITE_API_URL='$VITE_API_URL' && timeout 1800 bash deploy-multi-app.sh"

