name: Deploy Multiple Apps to EC2

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name to deploy (leave empty for all apps)'
        required: false
        type: string

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  test-and-deploy:
    name: Test, Build & Deploy All Apps
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts || true
        
    # Deploy configuration and scripts to EC2
    - name: Deploy deployment scripts to EC2
      run: |
        echo "ðŸ“¦ Copying deployment scripts to EC2..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 $EC2_USER@$EC2_HOST "mkdir -p ~/deployment"
        scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 deploy-multi-app.sh $EC2_USER@$EC2_HOST:~/deployment/ || exit 1
        scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 apps.config.json $EC2_USER@$EC2_HOST:~/deployment/ || exit 1
        scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 ecosystem.config.js $EC2_USER@$EC2_HOST:~/deployment/ || exit 1
        echo "âœ… Deployment scripts copied"
        
    - name: Execute multi-app deployment script on EC2
      timeout-minutes: 30
      env:
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        RAZORPAY_KEY_ID: ${{ secrets.RAZORPAY_KEY_ID }}
        RAZORPAY_KEY_SECRET: ${{ secrets.RAZORPAY_KEY_SECRET }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NODE_ENV: ${{ secrets.NODE_ENV || 'production' }}
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
      run: |
        echo "ðŸš€ Starting multi-app deployment..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes $EC2_USER@$EC2_HOST "cd ~/deployment && chmod +x deploy-multi-app.sh && export JWT_SECRET='$JWT_SECRET' && export EMAIL_USER='$EMAIL_USER' && export EMAIL_PASS='$EMAIL_PASS' && export RAZORPAY_KEY_ID='$RAZORPAY_KEY_ID' && export RAZORPAY_KEY_SECRET='$RAZORPAY_KEY_SECRET' && export DATABASE_URL='$DATABASE_URL' && export NODE_ENV='${NODE_ENV:-production}' && export VITE_API_URL='$VITE_API_URL' && timeout 1800 bash deploy-multi-app.sh"

