name: Deploy to EC2

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test-and-deploy:
    name: Test, Build & Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    # Backend Tests
    - name: Install backend dependencies
      working-directory: ./backend
      run: npm ci
      
    - name: Generate Prisma Client
      working-directory: ./backend
      run: npm run prisma:generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL || 'file:./dev.db' }}
        NODE_ENV: test
        
    # Frontend Build
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci --legacy-peer-deps
      
    - name: Build frontend
      working-directory: ./frontend
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:5000/api' }}
        NODE_ENV: production
      run: npm run build
      
    # Deploy to EC2 using rsync (faster and excludes node_modules)
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || true
    
    - name: Test SSH Connection
      timeout-minutes: 2
      run: |
        echo "ðŸ” Testing SSH connection to ${{ secrets.EC2_HOST }}..."
        MAX_RETRIES=3
        RETRY_COUNT=0
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
          if timeout 15 ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH OK'" 2>&1; then
            echo "âœ… SSH connection successful"
            exit 0
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Retrying in 3 seconds..."
              sleep 3
            fi
          fi
        done
        echo "âŒ SSH connection failed after $MAX_RETRIES attempts"
        echo "âš ï¸  EC2 instance is not reachable. Please check:"
        echo "   1. EC2 instance is running (not stopped/terminated)"
        echo "   2. Security group allows SSH (port 22) from 0.0.0.0/0 or GitHub Actions IPs"
        echo "   3. EC2_HOST secret is correct: ${{ secrets.EC2_HOST }}"
        echo "   4. Instance public IP hasn't changed"
        exit 1
    
    - name: Deploy to EC2 via rsync
      timeout-minutes: 10
      run: |
        echo "ðŸ“¦ Deploying to EC2 (excluding node_modules and .git)..."
        timeout 300 rsync -avz --progress \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude 'frontend/dist' \
          --exclude 'backend/node_modules' \
          --exclude 'frontend/node_modules' \
          --exclude '.github' \
          --exclude '*.log' \
          --exclude '*.md' \
          -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15" \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/hope-physicians/ || {
          echo "âŒ Rsync failed"
          echo "âš ï¸  This usually means the EC2 instance is not accessible"
          exit 1
        }
        echo "âœ… Files deployed"
        
    - name: Execute deployment script on EC2
      timeout-minutes: 30
      env:
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        RAZORPAY_KEY_ID: ${{ secrets.RAZORPAY_KEY_ID }}
        RAZORPAY_KEY_SECRET: ${{ secrets.RAZORPAY_KEY_SECRET }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        PORT: ${{ secrets.PORT || '5000' }}
        NODE_ENV: ${{ secrets.NODE_ENV || 'production' }}
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
      run: |
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=30 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cd /home/${{ secrets.EC2_USER }}/hope-physicians && chmod +x deploy.sh && export JWT_SECRET='$JWT_SECRET' && export EMAIL_USER='$EMAIL_USER' && export EMAIL_PASS='$EMAIL_PASS' && export RAZORPAY_KEY_ID='$RAZORPAY_KEY_ID' && export RAZORPAY_KEY_SECRET='$RAZORPAY_KEY_SECRET' && export DATABASE_URL='$DATABASE_URL' && export PORT='${PORT:-5000}' && export NODE_ENV='${NODE_ENV:-production}' && export VITE_API_URL='$VITE_API_URL' && timeout 1800 bash deploy.sh"
          
    - name: Verify deployment and run diagnostics
      timeout-minutes: 2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cd /home/${{ secrets.EC2_USER }}/hope-physicians && (chmod +x check-deployment.sh 2>/dev/null && ./check-deployment.sh || (echo 'Running basic checks...' && pm2 status && sudo systemctl status nginx --no-pager -l 2>/dev/null || true)) && echo 'âœ… Deployment verification completed'"
