name: Deploy to Firebase

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: "18"
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

jobs:
  # Build and test frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Create production environment file
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env.production
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Build frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # Build and test backend functions
  build-backend:
    name: Build Backend Functions
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup Prisma
        run: npx prisma generate

      - name: Lint functions
        run: |
          if [ -d "functions" ]; then
            cd functions
            npm ci || true
            npm run lint || true
          fi
        continue-on-error: true

      - name: Upload functions artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-functions
          path: backend/functions
          retention-days: 1
          if-no-files-found: ignore

  # Deploy to Firebase
  deploy:
    name: Deploy to Firebase
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-functions
          path: backend/functions
        continue-on-error: true

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Firebase Service Account
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > /tmp/firebase-service-account.json
          chmod 600 /tmp/firebase-service-account.json
          # Verify JSON is valid
          if ! python3 -m json.tool /tmp/firebase-service-account.json > /dev/null 2>&1; then
            echo "‚ùå Error: Invalid JSON in FIREBASE_SERVICE_ACCOUNT secret"
            exit 1
          fi
          echo "‚úÖ Service account JSON is valid"

      - name: Verify Firebase Project Access
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-service-account.json
        run: |
          # Verify project ID is set
          if [ -z "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
            echo "‚ùå Error: FIREBASE_PROJECT_ID secret is not set"
            exit 1
          fi
          echo "üìã Project ID: ${{ secrets.FIREBASE_PROJECT_ID }}"

          # Create .firebaserc if it doesn't exist
          if [ ! -f .firebaserc ]; then
            echo "{\"projects\":{\"default\":\"${{ secrets.FIREBASE_PROJECT_ID }}\"}}" > .firebaserc
            echo "‚úÖ Created .firebaserc"
          fi

          # Verify firebase.json exists
          if [ ! -f firebase.json ]; then
            echo "‚ùå Error: firebase.json not found!"
            exit 1
          fi
          echo "‚úÖ firebase.json found"

          # List available projects to verify access
          echo "üîç Verifying Firebase project access..."
          firebase projects:list || echo "‚ö†Ô∏è Warning: Could not list projects, but continuing..."

      - name: Set Firebase Project
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-service-account.json
        run: |
          firebase use ${{ secrets.FIREBASE_PROJECT_ID }} --non-interactive || {
            echo "‚ùå Error: Failed to set Firebase project"
            echo "Please verify:"
            echo "1. FIREBASE_PROJECT_ID secret is correct: ${{ secrets.FIREBASE_PROJECT_ID }}"
            echo "2. FIREBASE_SERVICE_ACCOUNT has access to this project"
            echo "3. Service account has Firebase Admin permissions"
            exit 1
          }
          echo "‚úÖ Firebase project set to: ${{ secrets.FIREBASE_PROJECT_ID }}"

      - name: Install backend functions dependencies
        run: |
          if [ -d "backend/functions" ]; then
            echo "üì¶ Installing backend functions dependencies..."
            cd backend/functions
            npm ci
            # Generate Prisma client if needed
            if [ -d "prisma" ]; then
              npx prisma generate
            fi
          else
            echo "‚ö†Ô∏è Warning: backend/functions directory not found - skipping functions deployment"
          fi

      - name: Deploy to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-service-account.json
        run: |
          if [ -d "backend/functions" ]; then
            echo "üöÄ Deploying hosting and functions..."
            firebase deploy --only hosting,functions
          else
            echo "üöÄ Deploying hosting only (functions not found)..."
            firebase deploy --only hosting
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/firebase-service-account.json

      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Frontend: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo "API: https://us-central1-${{ secrets.FIREBASE_PROJECT_ID }}.cloudfunctions.net/api"
