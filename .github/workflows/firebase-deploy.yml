name: Deploy to Firebase

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

jobs:
  # Build and test frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Create production environment file
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env.production
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Build frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # Build and test backend functions
  build-backend:
    name: Build Backend Functions
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup Prisma
        run: |
          cd prisma
          npx prisma generate

      - name: Lint functions
        run: |
          if [ -d "functions" ]; then
            cd functions
            npm ci || true
            npm run lint || true
          fi
        continue-on-error: true

      - name: Upload functions artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-functions
          path: backend/functions
          retention-days: 1
          if-no-files-found: ignore

  # Deploy to Firebase
  deploy:
    name: Deploy to Firebase
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-functions
          path: backend/functions
          if-no-files-found: ignore

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate Firebase
        run: |
          firebase use ${{ secrets.FIREBASE_PROJECT_ID }} --token ${{ secrets.FIREBASE_TOKEN }}

      - name: Install backend functions dependencies
        run: |
          if [ -d "backend/functions" ]; then
            cd backend/functions
            npm ci
            # Generate Prisma client if needed
            if [ -d "prisma" ]; then
              npx prisma generate
            fi
          fi
        continue-on-error: true

      - name: Deploy to Firebase
        run: |
          firebase deploy --only hosting,functions --token ${{ secrets.FIREBASE_TOKEN }} --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Cleanup
        if: always()
        run: |
          rm -f $HOME/firebase-service-account.json

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Frontend: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo "API: https://us-central1-${{ secrets.FIREBASE_PROJECT_ID }}.cloudfunctions.net/api"

