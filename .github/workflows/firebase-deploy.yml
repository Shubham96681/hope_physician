name: Deploy to Firebase

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: "18"
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

jobs:
  # Build and test frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Create production environment file
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env.production
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Build frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # Build and test backend functions
  build-backend:
    name: Build Backend Functions
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup Prisma
        run: npx prisma generate

      - name: Lint functions
        run: |
          if [ -d "functions" ]; then
            cd functions
            npm ci || true
            npm run lint || true
          fi
        continue-on-error: true

      - name: Upload functions artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-functions
          path: backend/functions
          retention-days: 1
          if-no-files-found: ignore

  # Deploy to Firebase
  deploy:
    name: Deploy to Firebase
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-functions
          path: backend/functions
        continue-on-error: true

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Firebase Service Account
        run: |
          set -e
          
          # Write service account JSON
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > /tmp/firebase-service-account.json
          chmod 600 /tmp/firebase-service-account.json
          
          # Validate JSON format
          if ! python3 -m json.tool /tmp/firebase-service-account.json > /dev/null 2>&1; then
            echo "‚ùå Error: Invalid JSON in FIREBASE_SERVICE_ACCOUNT secret"
            exit 1
          fi
          
          # Extract project_id from JSON and verify it matches secret
          JSON_PROJECT_ID=$(python3 -c "import json; print(json.load(open('/tmp/firebase-service-account.json'))['project_id'])")
          SECRET_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          
          if [ -z "$SECRET_PROJECT_ID" ]; then
            echo "‚ùå Error: FIREBASE_PROJECT_ID secret is not set"
            exit 1
          fi
          
          if [ "$JSON_PROJECT_ID" != "$SECRET_PROJECT_ID" ]; then
            echo "‚ùå Error: Project ID mismatch!"
            echo "JSON project_id: $JSON_PROJECT_ID"
            echo "Secret project_id: $SECRET_PROJECT_ID"
            echo "These must match exactly!"
            exit 1
          fi
          
          echo "‚úÖ Service account JSON is valid"
          echo "‚úÖ Project ID matches: $JSON_PROJECT_ID"

      - name: Authenticate with Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-service-account.json
        run: |
          set -e
          
          PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          
          # Verify project exists and we have access
          echo "üîç Verifying Firebase project access..."
          if ! firebase projects:list --project "$PROJECT_ID" > /dev/null 2>&1; then
            echo "‚ùå Error: Cannot access Firebase project: $PROJECT_ID"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify project ID is correct: $PROJECT_ID"
            echo "2. Check service account has Firebase Admin permissions"
            echo "3. Ensure Firebase API is enabled for the project"
            echo "4. Verify service account JSON is valid and matches project"
            exit 1
          fi
          
          # Create .firebaserc for project context
          echo "{\"projects\":{\"default\":\"$PROJECT_ID\"}}" > .firebaserc
          
          # Verify firebase.json exists
          if [ ! -f firebase.json ]; then
            echo "‚ùå Error: firebase.json not found!"
            exit 1
          fi
          
          echo "‚úÖ Firebase authentication successful"
          echo "‚úÖ Project access verified: $PROJECT_ID"

      - name: Install backend functions dependencies
        run: |
          if [ -d "backend/functions" ]; then
            echo "üì¶ Installing backend functions dependencies..."
            cd backend/functions
            npm ci || {
              echo "‚ö†Ô∏è Warning: npm ci failed, trying npm install"
              npm install
            }
            # Generate Prisma client if needed
            if [ -d "prisma" ]; then
              npx prisma generate || echo "‚ö†Ô∏è Warning: Prisma generate failed"
            fi
          else
            echo "‚ÑπÔ∏è backend/functions directory not found - skipping"
          fi

      - name: Deploy to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-service-account.json
          FIREBASE_FUNCTIONS_REGION: us-central1
        run: |
          set -e
          
          PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          DEPLOY_SUCCESS=false
          
          # Determine what to deploy with proper error handling
          if [ -d "backend/functions" ] && [ -f "backend/functions/index.js" ]; then
            echo "üöÄ Deploying hosting and functions..."
            if firebase deploy \
              --project "$PROJECT_ID" \
              --non-interactive \
              --only hosting,functions; then
              DEPLOY_SUCCESS=true
            else
              echo "‚ùå Deployment failed for hosting and functions"
              exit 1
            fi
          else
            echo "üöÄ Deploying hosting only (functions not found or not configured)..."
            if firebase deploy \
              --project "$PROJECT_ID" \
              --non-interactive \
              --only hosting; then
              DEPLOY_SUCCESS=true
            else
              echo "‚ùå Deployment failed for hosting"
              exit 1
            fi
          fi
          
          if [ "$DEPLOY_SUCCESS" = true ]; then
            echo ""
            echo "‚úÖ Deployment successful!"
            echo "Frontend: https://$PROJECT_ID.web.app"
            echo "API: https://us-central1-$PROJECT_ID.cloudfunctions.net/api"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/firebase-service-account.json

      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Frontend: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo "API: https://us-central1-${{ secrets.FIREBASE_PROJECT_ID }}.cloudfunctions.net/api"
